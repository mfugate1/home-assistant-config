script:
  hall_of_holes_add_player:
    alias: Hall of Holes - Add Player
    mode: queued
    fields:
      browser_id:
        description: The browser ID this script is being called from
        default: hall-of-holes-tablet
    sequence:
      - variables:
          new_name: "{{ states('input_text.hall_of_holes_add_player_name') }}"
      - service: notify.hall_of_holes_db
        data:
          message: "CREATE TABLE IF NOT EXISTS players (id INT AUTO_INCREMENT PRIMARY KEY, name VARCHAR(64))"
      - service: mysql_query.query
        response_variable: existing_players_query
        data:
          query: SELECT name FROM players
      - if: "{{ new_name in (existing_players_query.result | map(attribute='name') | list) }}"
        then:
          - service: browser_mod.popup
            data:
              browser_id: "{{ browser_id }}"
              content: Player already exists in database.
        else:
          - service: notify.hall_of_holes_db
            data:
              message: "INSERT INTO players (name) VALUES ('{{ new_name }}')"
          - service: input_text.set_value
            entity_id: input_text.hall_of_holes_add_player_name
            data:
              value: ''
          - service: script.hall_of_holes_load_players
          - event: reload_hall_of_holes_player_id_mapping

  hall_of_holes_load_players:
    alias: Hall of Holes - Load Players
    mode: queued
    sequence:
      - service: mysql_query.query
        response_variable: existing_players_query
        data:
          query: SELECT name FROM players
      - service: input_select.set_options
        entity_id: 
          - input_select.hall_of_holes_player_1
          - input_select.hall_of_holes_player_2
          - input_select.hall_of_holes_player_3
          - input_select.hall_of_holes_player_4
        data:
          options: "{{ existing_players_query.result | map(attribute='name') | list }}"

input_select:
  hall_of_holes_games:
    name: Games
    options:
      - Air Hockey
      - Basketball
      - Darts
      - Pinball
      - Pool
      - Skeeball
  hall_of_holes_pool_game_types:
    name: Game Type
    options:
      - Standard
      - Teams
      - Cutthroat
  hall_of_holes_player_1:
    name: Player 1
    icon: mdi:handball
    options:
      - "Reload Me!"
  hall_of_holes_player_2:
    name: Player 2
    icon: mdi:handball
    options:
      - "Reload Me!"
  hall_of_holes_player_3:
    name: Player 3
    icon: mdi:handball
    options:
      - "Reload Me!"
  hall_of_holes_player_4:
    name: Player 4
    icon: mdi:handball
    options:
      - "Reload Me!"
  
input_text:
  hall_of_holes_add_player_name:
    name: Enter new player name here

template:
  - trigger:
      - platform: event
        event_type: reload_hall_of_holes_player_id_mapping
    action:
      - service: mysql_query.query
        response_variable: query
        data:
          query: SELECT id, name FROM players
    sensor:
      # Query result is stored in an attribute to avoid the 255 character limit on states
      - name: hall_of_holes_player_id_mapping
        state: no_state
        attributes:
          mapping: "{{ query.result }}"