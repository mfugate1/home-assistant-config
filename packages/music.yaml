template:
  - sensor:
      # Since the name of the Squeezebox group can change in spotify, this sensor
      # is used to always return the current name of it (or unavailable if the source
      # is missing)
      - name: spotify_whole_house_source_name
        state: >
          {% set ns = namespace(found=False) %}
          {% for i in state_attr('media_player.spotify_stukabombr1', 'source_list') %}
            {% if '&' in i and ',' in i %}
              {{ i }}
              {% set ns.found = True %}
            {% endif %}
          {% endfor %}
          {% if not ns.found %}
            unavailable
          {% endif %}

      # A list of rooms that synced music is currently playing in
      - name: active_music_rooms
        state: use_the_attribute
        attributes:
          rooms: >
            {% set ns = namespace(rooms=[]) %}
            {% if is_state('media_player.livingroom_receiver', 'on') 
              and is_state_attr('media_player.livingroom_receiver', 'source', states('input_select.livingroom_receiver_music_source')) 
              and is_state('media_player.livingroom_squeezebox', 'playing') %}
                {% set ns.rooms = ns.rooms + ['livingroom'] %}
            {% endif %}
            {% if is_state('media_player.garage_receiver', 'on') 
              and is_state_attr('media_player.garage_receiver', 'source', states('input_select.garage_receiver_music_source')) 
              and is_state('media_player.garage_squeezebox', 'playing') %}
                {% set ns.rooms = ns.rooms + ['garage'] %}
            {% endif %}
            {{ ns.rooms }}

  - select:
      - name: livingroom_receiver_music_source_2
        unique_id: livingroom_receiver_music_source_2
        state: "{{ states('input_text.livingroom_receiver_music_source') }}"
        options: "{{ state_attr('media_player.livingroom_receiver', 'source_list') }}"
        select_option:
          service: input_text.set_value
          entity_id: input_text.livingroom_receiver_music_source
          data:
            value: "{{ option }}"

input_text:
  livingroom_receiver_music_source:
