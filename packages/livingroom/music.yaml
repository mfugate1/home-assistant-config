input_number:
  livingroom_music_volume:
    min: 0
    max: 80
    mode: box

# Helpers for the template selects, should never need to be changed by a user.
input_text:
  livingroom_receiver_music_source:
  livingroom_spotify_playlist:

switch:
  - platform: template
    switches:
      livingroom_music:
        friendly_name: Music
        icon_template: mdi:music
        value_template: "{{ is_state('media_player.livingroom_receiver', 'on') and is_state('media_player.livingroom_squeezebox', 'playing') }}"
        availability_template: "{{ not is_state('media_player.livingroom_receiver', 'unavailable') and not is_state('media_player.livingroom_squeezebox', 'unavailable')}}"
        turn_on:
          - parallel:
            - service: script.livingroom_receiver_turn_on
              data:
                source: "{{ states('input_text.livingroom_music_receiver_source') }}"
                volume: "{{ states('input_number.livingroom_music_volume') }}"
            - sequence:
              - service: media_player.select_source
                entity_id: media_player.spotify_stukabombr1
                data:
                  source: "{{ states('sensor.spotify_whole_house_source_name') }}"
              - delay: "{{ states('input_number.spotify_source_change_delay') | int }}"
              - service: script.spotify_play_playlist
            - if: "{{ is_state('switch.livingroom_ps5', 'on') }}"
              then:
                service: script.livingroom_ps5_turn_off
        turn_off:
          - variables:
              number_of_rooms_music_is_playing_in: "{{ state_attr('active_music_rooms', 'rooms') | length }}"
          - service: media_player.turn_off
            entity_id: media_player.livingroom_receiver
          - if: "{{ number_of_rooms_music_is_playing_in == 1 }}"
            then:
              service: media_player.media_pause
              entity_id: media_player.spotify_stukabombr1

template:
  - select:
      # A dynamic select entity to configure which source the receiver should be set to to play music.
      - name: livingroom_receiver_music_source
        unique_id: livingroom_receiver_music_source
        state: "{{ states('input_text.livingroom_receiver_music_source') }}"
        options: "{{ state_attr('media_player.livingroom_receiver', 'source_list') }}"
        select_option:
          service: input_text.set_value
          entity_id: input_text.livingroom_receiver_music_source
          data:
            value: "{{ option }}"

      # Have select entities specific to each room, but pulling options from a master input_select.
      - name: livingroom_spotify_playlist
        unique_id: livingroom_spotify_playlist
        state: "{{ states('input_text.livingroom_spotify_playlist') }}"
        options: "{{ state_attr('input_select.spotify_playlists') }}"
        select_option:
          service: input_text.set_value
          entity_id: input_text.livingroom_receiver_music_source
          data:
            value: "{{ option }}"