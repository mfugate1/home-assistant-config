- sensor:
    - name: last_occupied_room
      state: >-
        {% set ns = namespace(all_off=True, last_updated_entity='', last_updated_date='') %}
        {% for state in states.group %}
          {% if state.entity_id.endswith('_occupancy') and state.state == 'on' %}
            {% set ns.all_off = False %}
          {% endif %}
        {% endfor %}
        {% for state in states.group %}
          {% if state.entity_id.endswith('_occupancy') and (ns.all_off or state.state == 'on')%}
            {% if ns.last_updated_entity == '' or state.last_updated > ns.last_updated_date %}
              {% set ns.last_updated_entity = state.entity_id %}
              {% set ns.last_updated_date = state.last_updated %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {{ ns.last_updated_entity.split('.')[1].split('_')[0] }}