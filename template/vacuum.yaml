- sensor:
    - name: vacuum_next_room_to_clean
      state: >-
        {% set clean_this = namespace(entity='none',last_cleaned='') %}
        {% set time = 'day' if is_state('input_boolean.sleep_mode', 'off') else 'night' %}
        {% for state in states.input_datetime %}
          {% if 'vacuum' in state.entity_id %}
            {% set room_enabled = is_state(state.entity_id.replace('datetime', 'boolean').replace('last_cleaned', time + '_enable'), 'on') %}
            {% set room_cleaned_today = is_state(state.entity_id.replace('datetime', 'boolean').replace('last_cleaned', 'cleaned_today'), 'on') %}
            {% set state_date = strptime(state.state, '%Y-%m-%d %H-%M-%S') %}
            {% if room_enabled and not room_cleaned_today and (clean_this.entity == 'none' or state_date < clean_this.last_cleaned) %}
              {% set clean_this.entity = state.entity_id %}
              {% set clean_this.last_cleaned = state_date %}
            {% endif %}
          {% endif %}
        {% endfor %}
        {{ clean_this.entity.replace('input_datetime.vacuum_', '').replace('_last_cleaned', '') }}     
      attributes:
        next_room: "{{ states('sensor.vacuum_next_room_to_clean').split('_')[0] }}"
        next_id: "{{ states('sensor.vacuum_next_room_to_clean').split('_')[1] }}"
        display_name: >-
          {% set raw = state_attr('sensor.vacuum_next_room_to_clean', 'next_room') %}
          {% if raw.endswith('bathroom') %}
            {{ raw.replace('bathroom', '').capitalize() }} Bathroom
          {% elif raw.endswith('room') %}
            {{ raw.replace('room', '').capitalize() }} Room
          {% else %}
            {{ raw.capitalize() }}
          {% endif %}
        label: "Start/Stop"
    - name: vacuum_gameroom_16_last_cleaned
      state: "{{ relative_time(as_datetime(states('input_datetime.vacuum_gameroom_16_last_cleaned'))) }}"
    - name: vacuum_hallway_17_last_cleaned
      state: "{{ relative_time(as_datetime(states('input_datetime.vacuum_hallway_17_last_cleaned'))) }}"
    - name: vacuum_bedroom_18_last_cleaned
      state: "{{ relative_time(as_datetime(states('input_datetime.vacuum_bedroom_18_last_cleaned'))) }}"
    - name: vacuum_livingroom_19_last_cleaned
      state: "{{ relative_time(as_datetime(states('input_datetime.vacuum_livingroom_19_last_cleaned'))) }}"
    - name: vacuum_kitchen_20_last_cleaned
      state: "{{ relative_time(as_datetime(states('input_datetime.vacuum_kitchen_20_last_cleaned'))) }}"
    - name: vacuum_diningroom_21_last_cleaned
      state: "{{ relative_time(as_datetime(states('input_datetime.vacuum_diningroom_21_last_cleaned'))) }}"
    - name: vacuum_office_22_last_cleaned
      state: "{{ relative_time(as_datetime(states('input_datetime.vacuum_office_22_last_cleaned'))) }}"
    - name: vacuum_upstairsbathroom_23_last_cleaned
      state: "{{ relative_time(as_datetime(states('input_datetime.vacuum_upstairsbathroom_23_last_cleaned'))) }}"
    